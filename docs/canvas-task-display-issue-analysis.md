# Canvas Task Display Issue Analysis

## Issue Summary
Tasks are being correctly generated by the Python A2A agent and stored in the database with proper linkage to the canvas document, but the Canvas UI is failing to display the task details despite the data being available.

## Root Cause Identified

The issue lies in the **data flow timing** between the canvas document creation and task fetching in the client component. Here's what's happening:

### Current Flow (Problematic)

1. **A2A Tool (`request-a2a-agent.ts`)**:
   - Sends request to Python agent (blocking mode)
   - Receives task data from agent response
   - Creates tasks in database with `createTaskQuery()`
   - Creates canvas document with `documentId`
   - Links tasks to document via `updateDocumentTaskIds()`
   - Returns document ID as artifact content

2. **Canvas Server Handler (`artifacts/canvas/server.ts`)**:
   - Returns the document ID as content (line 52-56)
   - This is correct and necessary for the client to fetch data

3. **Canvas Client (`artifacts/canvas/client.tsx`)**:
   - Receives document ID in `content` prop
   - Uses SWR to fetch document from `/api/document?id=${documentId}`
   - Gets document with `taskIds` array
   - **PROBLEM**: Attempts to fetch each task individually from `/api/tasks/${taskId}`
   - The API route returns task data, but the client component has **data transformation issues**

## Specific Problems Found

### 1. Task Data Structure Mismatch
**Location**: `artifacts/canvas/client.tsx` lines 320-338

The client is trying to access `task.result` to get task details, but the actual structure returned by `/api/tasks/[id]/route.ts` is different:

```typescript
// What the client expects (line 322-323):
const taskResult = task.result as TaskResultData;

// What the API actually returns (from route.ts):
{
  id: string,
  status: string,
  title: string,        // Direct property, not in result
  description: string,  // Direct property, not in result
  assignedAgent?: {...},
  statusMessage?: string,
  updatedAt?: string,
  createdAt?: string
}
```

The API route **flattens** the task structure, extracting `title` and `description` from `result` and returning them as top-level properties. However, the client is still trying to access them through `task.result`.

### 2. Debug Logs Show the Issue
Looking at the debug logs in the client:
- Line 206-247: Tasks are fetched successfully
- Line 324-330: The conversion to UI format tries to access `taskResult.title` and `taskResult.description` which are undefined
- This results in fallback titles like `Task ${id.slice(-8)}` being used

## Solution

The fix has been implemented to properly handle the flattened data structure returned by the API:

**In `artifacts/canvas/client.tsx`**:

### Changes Made:

1. **Updated task data extraction (lines 321-336)**:
```typescript
// Now correctly uses the flattened TaskStatusResponse structure
const uiTasks = (tasksData || []).map((task) => {
  return {
    id: task.id,
    title: task.title || `Task ${task.id.slice(-8)}`,
    description: task.description || task.statusMessage || `Status: ${task.status}`,
    status: transformTaskStatusToUI(task.status),
  };
});
```

2. **Updated agent extraction (lines 340-367)**:
```typescript
const uiAgents = (tasksData || [])
  .filter((task) => task.assignedAgent) // Direct property from API response
  .map((task) => {
    const assignedAgent = task.assignedAgent;
    return {
      id: assignedAgent.id || `agent-${task.id}`,
      name: assignedAgent.name || `Agent for ${task.title || 'Task'}`,
      // ... rest properly mapped
    };
  });
```

3. **Added proper TypeScript types**:
- Imported `TaskStatusResponse` from `@/lib/types/tasks`
- Properly typed the SWR response as `TaskStatusResponse[]`
- Removed redundant `TaskResultData` interface

4. **Enhanced debug logging** to track the actual API response structure

## Additional Observations

1. **Race Condition Handling**: The client has retry logic (lines 261-288) to handle race conditions between document creation and task storage. This is good but may not be necessary once the data structure issue is fixed.

2. **Document Fetching Works**: The document is correctly fetched with `taskIds` array populated.

3. **Task API Works**: Individual task fetching via `/api/tasks/${taskId}` is working correctly and returning data.

4. **Storage Works**: Tasks are properly stored in the database with all necessary fields.

## Testing Recommendations

After implementing the fix:
1. Test with a fresh A2A request to ensure tasks display immediately
2. Verify task titles and descriptions show correctly
3. Check that assigned agents are properly displayed
4. Ensure the canvas flow visualization shows all connections

## Conclusion

The issue is not with the data storage or fetching mechanisms, but with how the Canvas client component is trying to access the task data. The API returns a flattened structure, but the client expects a nested structure with details in a `result` property. A simple adjustment to use the correct data structure will resolve the issue.